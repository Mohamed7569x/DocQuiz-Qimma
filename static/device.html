<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Devices — PLC Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/static/logo.png">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: '#0f172a',
            muted: '#6b7280',
            border: '#e5e7eb',
            accent: '#2563eb',
          },
          boxShadow: {
            soft: '0 24px 60px -28px rgba(15,23,42,.25)',
          },
          borderRadius: {
            xl2: '18px',
          }
        }
      }
    }
  </script>

  <!-- Page baseline (align with your mini-rail sidebar) -->
  <style>
    :root{ --sb-open-w: 18rem; --sb-mini-w: 4.25rem; }
    @media (min-width:1024px){
      html body main[data-with-sidebar="1"]{ margin-inline-start: var(--sb-open-w); }
      /* If you toggle mini mode, you can dynamically set margin to --sb-mini-w via JS if desired */
    }
  </style>
</head>

<body class="min-h-screen bg-[radial-gradient(1200px_800px_at_10%_-10%,#eef3ff_0%,#f7f8fb_40%,#f7f8fb_100%)] text-ink selection:bg-accent/15 selection:text-ink">

  {% include "sidebar.html" %}

  <main class="p-6" style="margin-inline-start: var(--content-margin); padding-top: var(--topbar-h);">
    
    <!-- KPI Cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft p-4">
        <div class="text-sm text-muted">Total Devices</div>
        <div id="kpi_total" class="mt-1 text-3xl font-bold tracking-tight">—</div>
        <div class="mt-2 text-xs text-muted" id="kpi_total_hint">Last sync now</div>
      </div>
      <div class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft p-4">
        <div class="text-sm text-muted">ACTIVE</div>
        <div id="kpi_online" class="mt-1 text-3xl font-bold tracking-tight text-green-600">—</div>
        <div class="mt-2">
          <span class="inline-flex items-center rounded-full border border-green-200 bg-green-50 text-green-700 px-2 py-0.5 text-xs font-semibold">
            Healthy
          </span>
        </div>
      </div>
      <div class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft p-4">
        <div class="text-sm text-muted">OFFLINE</div>
        <div id="kpi_offline" class="mt-1 text-3xl font-bold tracking-tight text-red-600">—</div>
        <div class="mt-2">
          <span class="inline-flex items-center rounded-full border border-red-200 bg-red-50 text-red-700 px-2 py-0.5 text-xs font-semibold">
            Attention
          </span>
        </div>
      </div>
      <div class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft p-4">
        <div class="text-sm text-muted">MAINTENANCE</div>
        <div id="kpi_maint" class="mt-1 text-3xl font-bold tracking-tight text-amber-600">—</div>
        <div class="mt-2">
          <span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 text-amber-700 px-2 py-0.5 text-xs font-semibold">
            Scheduled
          </span>
        </div>
      </div>
    </section>

    <!-- Card: Filters + Table -->
    <section class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft overflow-hidden">
        <div class="px-5 py-4 border-b border-border flex flex-wrap items-center justify-between gap-3">
            <div>
              <h2 class="text-lg font-semibold tracking-tight">Devices</h2>
              <p class="text-xs text-muted">Manage connected PLC gateways and collectors</p>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnAdd"
                class="inline-flex items-center gap-2 rounded-xl bg-accent text-white px-4 py-2.5 font-medium hover:opacity-95 active:translate-y-px">
                <!-- plus icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11 5a1 1 0 1 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5z"/>
                </svg>
                Add Device
              </button>
            </div>
          </div>
      <!-- Filters -->
      <div class="px-5 py-4 border-b border-border">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <div class="md:col-span-1">
            <label class="block text-xs font-medium text-muted mb-1">Name</label>
            <input id="f_name" type="text" placeholder="Filter by name"
              class="w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs font-medium text-muted mb-1">IP address</label>
            <input id="f_ip" type="text" placeholder="192.168.0.10"
              class="w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs font-medium text-muted mb-1">Location</label>
            <input id="f_location" type="text" placeholder="e.g. Line A"
              class="w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs font-medium text-muted mb-1">Status</label>
            <select id="f_status"
              class="w-full rounded-xl border border-border px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
              <option value="">All status</option>
              <option value="ACTIVE">ACTIVE</option>
              <option value="OFFLINE">OFFLINE</option>
              <option value="MAINTENANCE">MAINTENANCE</option>
              <option value="FAULT">FAULT</option>
              <option value="WARNING">WARNING</option>
              <option value="DISABLED">DISABLED</option>
              <option value="UNKNOWN">UNKNOWN</option>
            </select>
          </div>
          <div class="md:col-span-1 flex items-end gap-2">
            <button id="btnSearch"
              class="w-full md:w-auto rounded-xl border border-border bg-white px-4 py-2.5 font-medium hover:bg-gray-50 active:translate-y-px">Search</button>
            <button id="btnReset"
              class="w-full md:w-auto rounded-xl border border-border bg-white px-4 py-2.5 font-medium hover:bg-gray-50 active:translate-y-px">Reset</button>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table id="devTbl" class="min-w-full text-sm">
            <thead class="sticky top-0 z-10 bg-white backdrop-blur text-gray-700 border-y border-border">
            <tr>
              <th class="text-left px-5 py-3 w-14">#</th>
              <th class="text-left px-5 py-3">Name</th>
              <th class="text-left px-5 py-3">IP Address</th>
              <th class="text-left px-5 py-3">Location</th>
              <th class="text-left px-5 py-3">Status</th>
              <th class="text-left px-5 py-3 w-40">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border"></tbody>
        </table>

        <!-- Skeleton (shown while loading) -->
        <div id="skeleton" class="p-5 space-y-3 hidden">
          <div class="h-10 rounded-xl bg-gray-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-gray-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-gray-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-gray-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-gray-100 animate-pulse"></div>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="hidden p-12 text-center">
          <div class="mx-auto w-14 h-14 rounded-2xl bg-accent/10 text-accent grid place-items-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 3h6a2 2 0 0 1 2 2v3H7V5a2 2 0 0 1 2-2zm10 5v9a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8h14z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold">No devices found</h3>
          <p class="text-muted mt-1">Try adjusting filters or add a new device.</p>
          <button id="emptyAdd" class="mt-4 inline-flex items-center gap-2 rounded-xl bg-accent text-white px-4 py-2.5 font-medium hover:opacity-95">
            Add Device
          </button>
        </div>
      </div>

      <!-- Pager -->
      <div class="px-5 py-4 border-t border-border flex flex-wrap items-center justify-between gap-3">
        <span id="pgInfo" class="text-muted">Page —</span>
        <div class="flex items-center gap-2">
          <button id="pgPrev" class="rounded-xl border border-border bg-white px-3 py-2 hover:bg-gray-50 disabled:opacity-50">Prev</button>
          <input id="pgInput" type="text" value="1"
            class="w-16 text-center rounded-xl border border-border px-2 py-2 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40" />
          <button id="pgNext" class="rounded-xl border border-border bg-white px-3 py-2 hover:bg-gray-50 disabled:opacity-50">Next</button>
          <select id="pgSize"
            class="rounded-xl border border-border px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
            <option>10</option><option>25</option><option>50</option>
          </select>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="dlg" class="fixed inset-0 z-50 hidden place-items-center bg-black/30 p-4">
    <div class="w-full max-w-xl rounded-2xl border border-border bg-white shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-border">
        <span id="dlgTitle" class="font-semibold">Add Device</span>
        <button id="dlgClose" class="rounded-lg px-2 py-1.5 hover:bg-gray-100">✕</button>
      </div>
      <div class="p-5">
        <form id="frm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-muted mb-1">Name</label>
            <input id="m_name" type="text" required
              class="w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
            <div id="e_name" class="text-red-600 text-xs mt-1"></div>
          </div>
          <div>
            <label class="block text-sm text-muted mb-1">IP Address</label>
            <input id="m_ip" type="text" placeholder="192.168.0.10" required
              class="w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
            <div id="e_ip" class="text-red-600 text-xs mt-1"></div>
          </div>
          <div>
            <label class="block text-sm text-muted mb-1">Location</label>
            <input id="m_location" type="text"
              class="w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
            <div id="e_location" class="text-red-600 text-xs mt-1"></div>
          </div>
          <div>
            <label class="block text-sm text-muted mb-1">Status</label>
            <select id="m_status"
              class="w-full rounded-xl border border-border px-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
              <option value="ACTIVE" selected="selected">ACTIVE</option>
              <option value="OFFLINE">OFFLINE</option>
              <option value="MAINTENANCE">MAINTENANCE</option>
              <option value="FAULT">FAULT</option>
              <option value="WARNING">WARNING</option>
              <option value="DISABLED">DISABLED</option>
              <option value="UNKNOWN">UNKNOWN</option>
            </select>
            <div id="e_status" class="text-red-600 text-xs mt-1"></div>
          </div>

          <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
            <button type="button" id="dlgCancel"
              class="rounded-xl border border-border bg-white px-4 py-2.5 font-medium hover:bg-gray-50">
              Cancel
            </button>
            <button type="submit" id="dlgSave"
              class="rounded-xl bg-accent text-white px-5 py-2.5 font-medium hover:opacity-95 active:translate-y-px">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 z-[60] hidden">
    <div class="rounded-xl bg-gray-900 text-white px-4 py-3 shadow-2xl/50 shadow-xl text-sm" id="toastMsg">Saved</div>
  </div>

  <!-- Page Script -->
  <script>
    /* ================= CONFIG ================= */
    const API_BASE = "";
    const EP_LIST   = "/api/v1/device";
    const EP_CREATE = "/api/v1/device";
    const EP_UPDATE = "/api/v1/device"; // with ?deivceId=<id>
    const UPDATE_ID_PARAM = "deivceId";

    /* ================= STATE ================= */
    const state = {
      page: 1, per_page: 10, total: 0, items: [], editing: null,
      filters: { name:"", ip_address:"", status:"", location:"" },
      loading: false,
    };

    /* ================= HELPERS ================= */
    const $ = s => document.querySelector(s);
    const ipRegex = /^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)$/;

    function badge(status){
      if(!status) return "";
      const s = String(status);
      if(s==="ACTIVE") return '<span class="inline-flex items-center rounded-full border border-green-200 bg-green-50 text-green-700 px-2.5 py-1 text-xs font-semibold">ACTIVE</span>';
      if(s==="OFFLINE") return '<span class="inline-flex items-center rounded-full border border-red-200 bg-red-50 text-red-700 px-2.5 py-1 text-xs font-semibold">OFFLINE</span>';
      return '<span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 text-amber-700 px-2.5 py-1 text-xs font-semibold">'+status+'</span>';
    }

    function qs(params){
      const p = new URLSearchParams();
      Object.entries(params).forEach(([k,v])=>{
        if(v!==undefined && v!==null && String(v)!=="") p.append(k, v);
      });
      return p.toString();
    }

    function showToast(msg){
      $("#toastMsg").textContent = msg;
      const t = $("#toast");
      t.classList.remove("hidden");
      clearTimeout(t._to);
      t._to = setTimeout(()=> t.classList.add("hidden"), 2000);
    }

    function showSkeleton(on){
      $("#skeleton").classList.toggle("hidden", !on);
      $("#emptyState").classList.add("hidden");
      const tb = $("#devTbl tbody");
      if (on) tb.innerHTML = "";
    }

    function updateKpis(){
      const total = state.total || state.items.length;
      const ACTIVE = state.items.filter(d => String(d.status)==="ACTIVE").length;
      const OFFLINE = state.items.filter(d => String(d.status)==="OFFLINE").length;
      const MAINTENANCE = state.items.filter(d => String(d.status)==="MAINTENANCE").length;
      $("#kpi_total").textContent = total;
      $("#kpi_online").textContent = ACTIVE;
      $("#kpi_offline").textContent = OFFLINE;
      $("#kpi_maint").textContent = MAINTENANCE;
      $("#kpi_total_hint").textContent = "Last sync: " + new Date().toLocaleTimeString();
    }

    /* ================= DATA ================= */
    async function fetchDevices(){
      state.loading = true; showSkeleton(true);
      const params = {
        page: state.page, per_page: state.per_page,
        name: state.filters.name || undefined,
        ip_address: state.filters.ip_address || undefined,
        status: state.filters.status || undefined,
        location: state.filters.location || undefined,
      };
      const url = API_BASE + EP_LIST + "?" + qs(params);
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok){ state.loading=false; showSkeleton(false); throw new Error("Failed to fetch devices: " + res.status); }
      const data = await res.json();
      state.items = data.items || [];
      state.total = data.total ?? state.items.length;
      state.page = data.page || state.page;
      state.per_page = data.per_page || state.per_page;
      state.loading = false; showSkeleton(false);
      renderTable();
      renderPager();
      updateKpis();
      $("#emptyState").classList.toggle("hidden", state.items.length>0);
    }

    async function createDevice(payload){
      const res = await fetch(API_BASE + EP_CREATE, {
        method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(payload),
      });
      if(!res.ok){ throw new Error("Create failed: " + res.status); }
      return res.json();
    }

    async function updateDevice(id, payload){
      const url = API_BASE + EP_UPDATE + "?" + UPDATE_ID_PARAM + "=" + encodeURIComponent(id);
      const res = await fetch(url, {
        method: "PUT", headers: { "Content-Type":"application/json" }, body: JSON.stringify(payload),
      });
      if(!res.ok){ throw new Error("Update failed: " + res.status); }
      return res.json();
    }

    /* ================= RENDER ================= */
    function renderTable(){
      const tb = $("#devTbl tbody");
      tb.innerHTML = "";
      if(!state.items.length) return;

      state.items.forEach((d, idx)=>{
        const tr = document.createElement("tr");
        tr.className = "hover:bg-[#fafcff]/80";
        tr.innerHTML = `
          <td class="px-5 py-3 text-gray-700">${((state.page-1)*state.per_page) + idx + 1}</td>
          <td class="px-5 py-3 font-medium">${escapeHtml(d.name || "")}</td>
          <td class="px-5 py-3">${escapeHtml(d.ip_address || "")}</td>
          <td class="px-5 py-3">${escapeHtml(d.location || "")}</td>
          <td class="px-5 py-3">${badge(d.status)}</td>
          <td class="px-5 py-3">
            <div class="flex items-center gap-2">
              <button data-act="edit" data-id="${d.id}"
                class="rounded-lg border border-border bg-white px-3 py-1.5 hover:bg-gray-50">
                Edit
              </button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      });

      tb.querySelectorAll('button[data-act="edit"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-id");
          const row = state.items.find(x=>String(x.id)===String(id));
          openModal(row);
        });
      });
    }

    function renderPager(){
      const totalPages = Math.max(1, Math.ceil(state.total / state.per_page));
      $("#pgInfo").textContent = `Page ${state.page} / ${totalPages} — ${state.total} items`;
      $("#pgInput").value = state.page;
      $("#pgPrev").disabled = state.page <= 1;
      $("#pgNext").disabled = state.page >= totalPages;
    }

    /* ================= UI EVENTS ================= */
    $("#btnSearch").addEventListener("click", ()=>{
      state.filters.name = $("#f_name").value.trim();
      state.filters.ip_address = $("#f_ip").value.trim();
      state.filters.status = $("#f_status").value.trim();
      state.filters.location = $("#f_location").value.trim();
      state.page = 1;
      fetchDevices().catch(err=>showToast(err.message));
    });

    $("#btnReset").addEventListener("click", ()=>{
      $("#f_name").value = $("#f_ip").value = $("#f_location").value = "";
      $("#f_status").value = "";
      state.filters = { name:"", ip_address:"", status:"", location:"" };
      state.page = 1;
      fetchDevices().catch(err=>showToast(err.message));
    });

    $("#pgPrev").addEventListener("click", ()=>{
      if(state.page>1){ state.page--; fetchDevices().catch(err=>showToast(err.message)); }
    });
    $("#pgNext").addEventListener("click", ()=>{
      const totalPages = Math.max(1, Math.ceil(state.total / state.per_page));
      if(state.page<totalPages){ state.page++; fetchDevices().catch(err=>showToast(err.message)); }
    });
    $("#pgInput").addEventListener("change", (e)=>{
      const v = parseInt(e.target.value || "1", 10);
      const totalPages = Math.max(1, Math.ceil(state.total / state.per_page));
      state.page = Math.min(Math.max(1, v), totalPages);
      fetchDevices().catch(err=>showToast(err.message));
    });
    $("#pgSize").addEventListener("change", (e)=>{
      state.per_page = parseInt(e.target.value, 10);
      state.page = 1;
      fetchDevices().catch(err=>showToast(err.message));
    });

    $("#emptyAdd").addEventListener("click", ()=> openModal(null));

    // Modal
    const dlg = $("#dlg");
    $("#btnAdd").addEventListener("click", ()=>openModal(null));
    $("#dlgClose").addEventListener("click", closeModal);
    $("#dlgCancel").addEventListener("click", closeModal);

    function openModal(row){
      clearErrors();
      state.editing = row ? { ...row } : null;
      $("#dlgTitle").textContent = row ? "Edit Device" : "Add Device";
      $("#m_name").value = row?.name || "";
      $("#m_ip").value = row?.ip_address || "";
      $("#m_location").value = row?.location || "";
      $("#m_status").value = (row?.status || "ACTIVE");
      dlg.classList.remove("hidden");
      dlg.classList.add("grid");
    }
    function closeModal(){
      dlg.classList.add("hidden");
      dlg.classList.remove("grid");
      state.editing = null;
    }
    function clearErrors(){
      ["e_name","e_ip","e_location","e_status"].forEach(id=>$("#"+id).textContent="");
    }

    $("#frm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearErrors();
      const payload = {
        name: $("#m_name").value.trim(),
        ip_address: $("#m_ip").value.trim(),
        location: $("#m_location").value.trim(),
        status: $("#m_status").value.trim(),
      };
      let ok = true;
      if(!payload.name){ $("#e_name").textContent = "Name is required"; ok=false; }
      if(!ipRegex.test(payload.ip_address)){ $("#e_ip").textContent = "Invalid IPv4"; ok=false; }
      if(!payload.status){ $("#e_status").textContent = "Status is required"; ok=false; }
      if(!ok) return;

      try{
        if(state.editing && state.editing.id!=null){
          await updateDevice(state.editing.id, payload);
          showToast("Device updated");
        }else{
          await createDevice(payload);
          showToast("Device added");
        }
        closeModal();
        fetchDevices().catch(err=>showToast(err.message));
      }catch(err){
        showToast(err.message);
      }
    });

    /* ================= UTIL ================= */
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    /* ================= INIT ================= */
    fetchDevices().catch(err=>showToast(err.message));
  </script>
</body>
</html>
