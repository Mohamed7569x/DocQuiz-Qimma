<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Templates — PLC Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/static/logo.png">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: '#0f172a',
            muted: '#6b7280',
            border: '#e5e7eb',
            accent: '#2563eb',
          },
          boxShadow: { soft: '0 24px 60px -28px rgba(15,23,42,.25)' },
          borderRadius: { xl2: '18px' }
        }
      }
    }
  </script>
  <style>
    :root{ --sb-open-w: 18rem; --sb-mini-w: 4.25rem; }
    @media (min-width:1024px){
      html body main[data-with-sidebar="1"]{ margin-inline-start: var(--sb-open-w); }
    }
    .code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="min-h-screen bg-[radial-gradient(1200px_800px_at_10%_-10%,#eef3ff_0%,#f7f8fb_40%,#f7f8fb_100%)] text-ink">

  {% include "sidebar.html" %}

  <main class="p-6" style="margin-inline-start: var(--content-margin); padding-top: var(--topbar-h);" data-with-sidebar="1">
    <!-- Header -->
    <section class="mb-6 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Templates</h1>
        <p class="text-muted text-sm">Reusable rule packs for sensors</p>
      </div>
      <div class="flex gap-2">
        <button id="btnAdd" class="rounded-xl bg-accent text-white px-4 py-2.5 font-medium hover:opacity-95 active:translate-y-px">
          + New Template
        </button>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft p-4">
        <div class="text-sm text-muted">Templates</div>
        <div id="kpi_total" class="mt-1 text-3xl font-bold tracking-tight">—</div>
        <div class="mt-2 text-xs text-muted" id="kpi_hint">Last sync now</div>
      </div>
      <div class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft p-4">
        <div class="text-sm text-muted">Attached Sensors</div>
        <div id="kpi_attached" class="mt-1 text-3xl font-bold tracking-tight">—</div>
        <div class="mt-2 text-xs text-muted">Across all templates</div>
      </div>
      <div class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft p-4">
        <div class="text-sm text-muted">Templates w/ Spec</div>
        <div id="kpi_withspec" class="mt-1 text-3xl font-bold tracking-tight">—</div>
        <div class="mt-2 text-xs text-muted">Spec JSON provided</div>
      </div>
      <div class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft p-4">
        <div class="text-sm text-muted">Last Operation</div>
        <div id="kpi_lastop" class="mt-1 text-3xl font-bold tracking-tight">—</div>
        <div class="mt-2 text-xs text-muted">Create / Update / Attach</div>
      </div>
    </section>

    <!-- Card: Filters + Table -->
    <section class="rounded-2xl border border-border bg-white/80 backdrop-blur shadow-soft overflow-hidden">
      <!-- Filters -->
      <div class="px-5 py-4 border-b border-border">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
          <div class="md:col-span-2">
            <label class="block text-xs font-medium text-muted mb-1">Search</label>
            <input id="f_q" type="text" placeholder="Filter by name"
              class="w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
          </div>
          <div class="flex items-end gap-2">
            <button id="btnSearch"
              class="w-full md:w-auto rounded-xl border border-border bg-white px-4 py-2.5 font-medium hover:bg-gray-50 active:translate-y-px">Search</button>
            <button id="btnReset"
              class="w-full md:w-auto rounded-xl border border-border bg-white px-4 py-2.5 font-medium hover:bg-gray-50 active:translate-y-px">Reset</button>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table id="tplTbl" class="min-w-full text-sm">
          <thead class="sticky top-0 z-10 bg-white backdrop-blur text-gray-700 border-y border-border">
            <tr>
              <th class="text-left px-5 py-3 w-14">#</th>
              <th class="text-left px-5 py-3">Name</th>
              <th class="text-left px-5 py-3">Has Spec</th>
              <th class="text-left px-5 py-3">Attached</th>
              <th class="text-left px-5 py-3 w-56">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border"></tbody>
        </table>

        <!-- Skeleton -->
        <div id="skeleton" class="p-5 space-y-3 hidden">
          <div class="h-10 rounded-xl bg-gray-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-gray-100 animate-pulse"></div>
          <div class="h-10 rounded-xl bg-gray-100 animate-pulse"></div>
        </div>

        <!-- Empty -->
        <div id="emptyState" class="hidden p-12 text-center">
          <div class="mx-auto w-14 h-14 rounded-2xl bg-accent/10 text-accent grid place-items-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6v12m6-6H6"/></svg>
          </div>
          <h3 class="text-lg font-semibold">No templates</h3>
          <p class="text-muted mt-1">Create your first template.</p>
          <button id="emptyAdd" class="mt-4 inline-flex items-center gap-2 rounded-xl bg-accent text-white px-4 py-2.5 font-medium hover:opacity-95">
            New Template
          </button>
        </div>
      </div>

      <!-- Pager -->
      <div class="px-5 py-4 border-t border-border flex flex-wrap items-center justify-between gap-3">
        <span id="pgInfo" class="text-muted">Page —</span>
        <div class="flex items-center gap-2">
          <button id="pgPrev" class="rounded-xl border border-border bg-white px-3 py-2 hover:bg-gray-50 disabled:opacity-50">Prev</button>
          <input id="pgInput" type="text" value="1"
            class="w-16 text-center rounded-xl border border-border px-2 py-2 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40" />
          <button id="pgNext" class="rounded-xl border border-border bg-white px-3 py-2 hover:bg-gray-50 disabled:opacity-50">Next</button>
          <select id="pgSize"
            class="rounded-xl border border-border px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
            <option>10</option><option>25</option><option>50</option>
          </select>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal: Create / Edit Template -->
  <div id="dlgTpl" class="fixed inset-0 z-50 hidden grid place-items-center bg-black/30 p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-border bg-white shadow-soft ring-1 ring-border overflow-hidden">
      <div class="sticky top-0 z-10 flex items-center justify-between px-5 py-4 border-b border-border bg-white/95 backdrop-blur">
        <span id="dlgTplTitle" class="font-semibold">New Template</span>
        <button id="dlgTplClose" class="rounded-lg px-2 py-1.5 hover:bg-gray-100">✕</button>
      </div>

      <div class="px-5 py-4 max-h-[75vh] overflow-y-auto">
        <form id="frmTpl" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm text-muted mb-1">Name</label>
            <input id="t_name" type="text" required
              class="w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
            <div id="e_t_name" class="text-red-600 text-xs mt-1 min-h-[1rem]"></div>
          </div>

          <div class="md:col-span-2">
            <div class="flex items-center justify-between">
              <label class="block text-sm text-muted mb-1">Spec JSON (optional)</label>
              <button type="button" id="btnSpecInsert"
                class="text-xs rounded-lg border border-border px-2 py-1 hover:bg-gray-50">Insert example</button>
            </div>
            <textarea id="t_spec" rows="12" placeholder='{"states":[...],"rules":[...]}' spellcheck="false"
              class="code w-full rounded-xl border border-border px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40"></textarea>
            <div class="mt-1 text-xs">
              <span id="specValid" class="hidden text-green-700">✓ JSON valid</span>
              <span id="specInvalid" class="hidden text-red-700">✗ Invalid JSON</span>
            </div>
          </div>

          <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
            <button type="button" id="dlgTplCancel"
              class="rounded-xl border border-border bg-white px-4 py-2.5 font-medium hover:bg-gray-50">Cancel</button>
            <button type="submit" id="dlgTplSave"
              class="rounded-xl bg-accent text-white px-5 py-2.5 font-medium hover:opacity-95 active:translate-y-px">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Attach Sensors -->
  <div id="dlgAttach" class="fixed inset-0 z-50 hidden grid place-items-center bg-black/30 p-4">
    <div class="w-full max-w-4xl rounded-2xl border border-border bg-white shadow-soft ring-1 ring-border overflow-hidden">
      <div class="sticky top-0 z-10 flex items-center justify-between px-5 py-4 border-b border-border bg-white/95 backdrop-blur">
        <span id="dlgAttachTitle" class="font-semibold">Attach Sensors</span>
        <button id="dlgAttachClose" class="rounded-lg px-2 py-1.5 hover:bg-gray-100">✕</button>
      </div>

      <div class="px-5 py-4 max-h-[75vh] overflow-y-auto">
        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
          <div class="md:col-span-2">
            <label class="block text-xs text-muted mb-1">Name</label>
            <input id="af_name" class="w-full rounded-xl border border-border px-3 py-2.5">
          </div>
          <div>
            <label class="block text-xs text-muted mb-1">Type</label>
            <input id="af_type" class="w-full rounded-xl border border-border px-3 py-2.5">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-muted mb-1">Device</label>
            <select id="af_device" class="w-full rounded-xl border border-border px-3 py-2.5 bg-white"></select>
          </div>
          <div class="flex items-end gap-2">
            <button id="abtnSearch" class="rounded-xl border border-border bg-white px-4 py-2.5 hover:bg-gray-50">Search</button>
            <button id="abtnReset"  class="rounded-xl border border-border bg-white px-4 py-2.5 hover:bg-gray-50">Reset</button>
          </div>
        </div>

        <!-- Results -->
        <div class="rounded-xl border border-border overflow-hidden">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 border-b border-border text-gray-700">
              <tr>
                <th class="px-4 py-2 w-10"><input id="chkAll" type="checkbox"></th>
                <th class="text-left px-4 py-2">Name</th>
                <th class="text-left px-4 py-2">Type</th>
                <th class="text-left px-4 py-2">Device</th>
                <th class="text-left px-4 py-2">Unit</th>
                <th class="text-left px-4 py-2">Address</th>
              </tr>
            </thead>
            <tbody id="attachTBody" class="divide-y divide-border"></tbody>
          </table>
          <div id="attachEmpty" class="hidden p-6 text-center text-muted">No sensors</div>
        </div>

        <div class="flex items-center justify-between mt-3">
          <div id="attachSelCount" class="text-sm text-muted">0 selected</div>
          <div class="flex gap-2">
            <button id="abtnCancel" class="rounded-xl border border-border bg-white px-4 py-2.5 hover:bg-gray-50">Cancel</button>
            <button id="abtnAttach" class="rounded-xl bg-accent text-white px-4 py-2.5 hover:opacity-95">Attach</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal: Attached Sensors -->
<div id="dlgAttachedList" class="fixed inset-0 z-50 hidden grid place-items-center bg-black/30 p-4">
    <div class="w-full max-w-5xl rounded-2xl border border-border bg-white shadow-soft ring-1 ring-border overflow-hidden">
      <div class="sticky top-0 z-10 flex items-center justify-between px-5 py-4 border-b border-border bg-white/95 backdrop-blur">
        <span id="dlgAttachedListTitle" class="font-semibold">Attached Sensors</span>
        <button id="dlgAttachedListClose" class="rounded-lg px-2 py-1.5 hover:bg-gray-100">✕</button>
      </div>
  
      <div class="px-5 py-4 max-h-[75vh] overflow-y-auto">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
          <div class="md:col-span-2">
            <label class="block text-xs text-muted mb-1">Name</label>
            <input id="vf_name" class="w-full rounded-xl border border-border px-3 py-2.5">
          </div>
          <div>
            <label class="block text-xs text-muted mb-1">Type</label>
            <input id="vf_type" class="w-full rounded-xl border border-border px-3 py-2.5">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-muted mb-1">Device</label>
            <select id="vf_device" class="w-full rounded-xl border border-border px-3 py-2.5 bg-white"></select>
          </div>
          <div class="flex items-end gap-2">
            <button id="vbtnSearch" class="rounded-xl border border-border bg-white px-4 py-2.5 hover:bg-gray-50">Search</button>
            <button id="vbtnReset"  class="rounded-xl border border-border bg-white px-4 py-2.5 hover:bg-gray-50">Reset</button>
          </div>
        </div>
  
        <div class="rounded-xl border border-border overflow-hidden">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 border-b border-border text-gray-700">
              <tr>
                <th class="text-left px-4 py-2">Name</th>
                <th class="text-left px-4 py-2">Type</th>
                <th class="text-left px-4 py-2">Device</th>
                <th class="text-left px-4 py-2">Unit</th>
                <th class="text-left px-4 py-2">Address</th>
                <th class="text-left px-4 py-2">Min / Max</th>
                <th class="text-left px-4 py-2">Config</th>
              </tr>
            </thead>
            <tbody id="attachedListBody" class="divide-y divide-border"></tbody>
          </table>
          <div id="attachedListEmpty" class="hidden p-6 text-center text-muted">No attached sensors</div>
        </div>
  
        <div class="flex items-center justify-between mt-3">
          <div id="attachedListInfo" class="text-sm text-muted">Page —</div>
          <div class="flex gap-2">
            <button id="vpgPrev" class="rounded-xl border border-border bg-white px-3 py-2 hover:bg-gray-50">Prev</button>
            <input id="vpgInput" type="text" value="1"
              class="w-16 text-center rounded-xl border border-border px-2 py-2 focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40" />
            <button id="vpgNext" class="rounded-xl border border-border bg-white px-3 py-2 hover:bg-gray-50">Next</button>
            <select id="vpgSize"
              class="rounded-xl border border-border px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent/40">
              <option>10</option><option>25</option><option>50</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
  

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 z-[60] hidden">
    <div class="rounded-xl bg-gray-900 text-white px-4 py-3 shadow-2xl/50 shadow-xl text-sm" id="toastMsg">Saved</div>
  </div>

  <script>
    /* ================= CONFIG ================= */
    const API_BASE = "";
    const EP_TEMPLATE_LIST   = "/api/v1/template";
    const EP_TEMPLATE_CREATE = "/api/v1/template";
    const EP_TEMPLATE_UPDATE = "/api/v1/template";       // ?templateId=<id>
    const EP_TEMPLATE_DELETE = "/api/v1/template";       // ?templateId=<id>
    const EP_TEMPLATE_ATTACH = "/api/v1/template/attach";
    const EP_TEMPLATE_ATTACHED = "/api/v1/template/attached";

    const EP_SENSOR_LIST     = "/api/v1/sensor";
    const EP_DEVICE_LIST     = "/api/v1/device";

    /* ================= STATE ================= */
    const state = {
      page: 1, per_page: 10, total: 0,
      items: [],         // templates
      devices: [],
      attachSensorRows: [],
      selectedTpl: null, // editing/attaching
      q: ""
    };

    /* ================= HELPERS ================= */
    const $ = s => document.querySelector(s);
    const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    const qs = (obj) => {
      const p = new URLSearchParams();
      Object.entries(obj).forEach(([k,v])=>{ if(v!==undefined && v!==null && String(v)!=="") p.append(k,v); });
      return p.toString();
    };
    function showToast(msg){
      $("#toastMsg").textContent = msg;
      const t = $("#toast"); t.classList.remove("hidden");
      clearTimeout(t._to); t._to = setTimeout(()=> t.classList.add("hidden"), 2000);
    }
    function showSkeleton(on){
      $("#skeleton").classList.toggle("hidden", !on);
      $("#emptyState").classList.add("hidden");
      const tb = $("#tplTbl tbody");
      if(on) tb.innerHTML = "";
    }

    function jsonValidate(str){
      if(!str || !str.trim()) return { ok:true, value:null };
      try { return { ok:true, value: JSON.parse(str) }; }
      catch(e){ return { ok:false, error: e.message }; }
    }

    function updateKpis(){
      const total = state.total || state.items.length;
      const withSpec = state.items.filter(x => !!(x.spec && x.spec.trim())).length;
      const attached = state.items.reduce((sum, t) => sum + (t.attached_count || 0), 0);
      $("#kpi_total").textContent = total;
      $("#kpi_withspec").textContent = withSpec;
      $("#kpi_attached").textContent = attached;
      $("#kpi_hint").textContent = "Last sync: " + new Date().toLocaleTimeString();
    }

    /* ================= API ================= */
    async function fetchTemplates(){
      showSkeleton(true);
      const url = API_BASE + EP_TEMPLATE_LIST + "?" + qs({ page: state.page, per_page: state.per_page, q: state.q || undefined });
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok){ showSkeleton(false); throw new Error("Templates fetch failed: "+res.status); }
      const data = await res.json();
      state.items = data.items || [];
      state.total = data.total ?? state.items.length;
      state.page = data.page || state.page;
      state.per_page = data.per_page || state.per_page;
      showSkeleton(false);
      renderTable();
      renderPager();
      updateKpis();
      $("#emptyState").classList.toggle("hidden", state.items.length>0);
    }

    async function createTemplate(payload){
      const res = await fetch(API_BASE + EP_TEMPLATE_CREATE, {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error("Create failed: " + res.status);
      return res.json();
    }

    async function updateTemplate(id, payload){
      const url = API_BASE + EP_TEMPLATE_UPDATE + "?" + qs({ templateId: id });
      const res = await fetch(url, { method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error("Update failed: " + res.status);
      return res.json();
    }

    async function deleteTemplate(id){
      const url = API_BASE + EP_TEMPLATE_DELETE + "?" + qs({ templateId: id });
      const res = await fetch(url, { method:"DELETE" });
      if(!res.ok) throw new Error("Delete failed: " + res.status);
      return res.json();
    }

    async function fetchDevicesOptions(){
      const url = API_BASE + EP_DEVICE_LIST + "?" + qs({ page:1, per_page: 1000 });
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) return;
      const data = await res.json();
      state.devices = data.items || [];
      const sel = $("#af_device");
      sel.innerHTML = '<option value="">All devices</option>' + state.devices.map(d=>`<option value="${escapeHtml(d.id)}">${escapeHtml(d.name || d.id)}</option>`).join("");
    }

    async function fetchSensorsForAttach(){
      const params = {
        page: 1, per_page: 1000,
        name: $("#af_name").value.trim() || undefined,
        type: $("#af_type").value.trim() || undefined,
        device_id: $("#af_device").value.trim() || undefined
      };
      const url = API_BASE + EP_SENSOR_LIST + "?" + qs(params);
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("Sensors fetch failed: " + res.status);
      const data = await res.json();
      state.attachSensorRows = data.items || [];
      renderAttachTable();
    }

    async function attachTemplateToSensors(template_id, sensor_ids){
      const res = await fetch(API_BASE + EP_TEMPLATE_ATTACH, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ template_id, sensor_ids })
      });
      if(!res.ok) throw new Error("Attach failed: " + res.status);
      return res.json();
    }

    /* ================= RENDER ================= */
    function renderTable(){
      const tb = $("#tplTbl tbody"); tb.innerHTML = "";
      if(!state.items.length) return;
      state.items.forEach((t, idx)=>{
        const tr = document.createElement("tr");
        tr.className = "hover:bg-[#fafcff]/80";
        const hasSpec = !!(t.spec && t.spec.trim());
        const attachedBtn = `
            <button data-act="view-attached" data-id="${t.id}"
                class="rounded-lg border border-border bg-white px-3 py-1.5 hover:bg-gray-50">
                View (${escapeHtml(t.attached_count ?? "0")})
            </button>
            `;
        tr.innerHTML = `
        <td class="px-5 py-3 text-gray-700">${((state.page-1)*state.per_page) + idx + 1}</td>
        <td class="px-5 py-3 font-medium">${escapeHtml(t.name || "")}</td>
        <td class="px-5 py-3">
            ${hasSpec ? '<span class="inline-flex ...">Yes</span>' : '<span class="inline-flex ...">No</span>'}
        </td>
        <td class="px-5 py-3">${attachedBtn}</td>
        <td class="px-5 py-3">
            <div class="flex flex-wrap items-center gap-2">
            <button data-act="edit" data-id="${t.id}" class="rounded-lg border border-border bg-white px-3 py-1.5 hover:bg-gray-50">Edit</button>
            <button data-act="attach" data-id="${t.id}" class="rounded-lg border border-border bg-white px-3 py-1.5 hover:bg-gray-50">Attach</button>
            <button data-act="delete" data-id="${t.id}" class="rounded-lg border border-red-200 bg-white text-red-700 px-3 py-1.5 hover:bg-red-50">Delete</button>
            </div>
        </td>
        `;
        tb.appendChild(tr);
      });

      // actions
      tb.querySelectorAll('button[data-act="edit"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-id");
          const row = state.items.find(x=>String(x.id)===String(id));
          openTplModal(row);
        });
        tb.querySelectorAll('button[data-act="view-attached"]').forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const id = btn.getAttribute("data-id");
    const row = state.items.find(x=>String(x.id)===String(id));
    openAttachedListModal(row);
  });
});

      });
      
      tb.querySelectorAll('button[data-act="attach"]').forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          const row = state.items.find(x=>String(x.id)===String(id));
          await openAttachModal(row);
        });
      });
      tb.querySelectorAll('button[data-act="delete"]').forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          const row = state.items.find(x=>String(x.id)===String(id));
          if(confirm(`Delete template “${row?.name}”?`)){
            try{ await deleteTemplate(id); showToast("Template deleted"); fetchTemplates(); }
            catch(e){ showToast(e.message); }
          }
        });
      });
    }

    function renderPager(){
      const totalPages = Math.max(1, Math.ceil(state.total / state.per_page));
      $("#pgInfo").textContent = `Page ${state.page} / ${totalPages} — ${state.total} items`;
      $("#pgInput").value = state.page;
      $("#pgPrev").disabled = state.page <= 1;
      $("#pgNext").disabled = state.page >= totalPages;
    }

    /* ================= EVENTS ================= */
    $("#btnSearch").addEventListener("click", ()=>{ state.q = $("#f_q").value.trim(); state.page=1; fetchTemplates().catch(e=>showToast(e.message)); });
    $("#btnReset").addEventListener("click", ()=>{ $("#f_q").value=""; state.q=""; state.page=1; fetchTemplates().catch(e=>showToast(e.message)); });

    $("#pgPrev").addEventListener("click", ()=>{ if(state.page>1){ state.page--; fetchTemplates().catch(e=>showToast(e.message)); }});
    $("#pgNext").addEventListener("click", ()=>{ const totalPages = Math.max(1, Math.ceil(state.total / state.per_page)); if(state.page<totalPages){ state.page++; fetchTemplates().catch(e=>showToast(e.message)); }});
    $("#pgInput").addEventListener("change", (e)=>{ const v = Math.max(1, parseInt(e.target.value || "1",10)); const totalPages = Math.max(1, Math.ceil(state.total / state.per_page)); state.page = Math.min(v,totalPages); fetchTemplates().catch(e=>showToast(e.message)); });
    $("#pgSize").addEventListener("change", (e)=>{ state.per_page = parseInt(e.target.value,10); state.page=1; fetchTemplates().catch(e=>showToast(e.message)); });

    $("#btnAdd").addEventListener("click", ()=> openTplModal(null));
    $("#emptyAdd").addEventListener("click", ()=> openTplModal(null));

    /* ================= TEMPLATE MODAL ================= */
    const dlgTpl = $("#dlgTpl");
    $("#dlgTplClose").addEventListener("click", closeTplModal);
    $("#dlgTplCancel").addEventListener("click", closeTplModal);

    function openTplModal(row){
      $("#dlgTplTitle").textContent = row ? "Edit Template" : "New Template";
      state.selectedTpl = row ? { ...row } : null;
      $("#t_name").value = row?.name || "";
      $("#t_spec").value = row?.spec || "";
      $("#specValid").classList.add("hidden");
      $("#specInvalid").classList.add("hidden");
      dlgTpl.classList.remove("hidden"); dlgTpl.classList.add("grid");
    }
    function closeTplModal(){ dlgTpl.classList.add("hidden"); dlgTpl.classList.remove("grid"); state.selectedTpl = null; }

    // Live JSON validation
    $("#t_spec").addEventListener("input", ()=>{
      const res = jsonValidate($("#t_spec").value);
      $("#specValid").classList.toggle("hidden", !res.ok);
      $("#specInvalid").classList.toggle("hidden", !!res.ok);
    });

    // Example spec
    $("#btnSpecInsert").addEventListener("click", ()=>{
      const example = {
        states: [{name:"STATE_A",max_duration_s:600},{name:"STATE_B",max_duration_s:900}],
        transitions: [{from:"STATE_A",to:"STATE_B"},{from:"STATE_B",to:"STATE_A"}],
        defaults: { sample_period_ms:1000, flatline_eps:0.001, missing_gap_ms:5000 },
        signals: [
          {alias:"LEVEL", tag:"role:level"},
          {alias:"TEMP", tag:"role:temperature"},
          {alias:"PRESS", tag:"role:pressure"}
        ],
        rules: [
          {"name":"RANGE","type":"threshold","feature":{"fn":"latest","signal":"TEMP"},"operator":"between","value":{"min":0,"max":120}},
          {"name":"ROC_BOUND","type":"threshold","window_s":20,"feature":{"fn":"roc","signal":"LEVEL"},"operator":"between","value":{"min":-0.02,"max":0.05}}
        ]
      };
      $("#t_spec").value = JSON.stringify(example, null, 2);
      $("#t_spec").dispatchEvent(new Event("input"));
    });

    $("#frmTpl").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const name = $("#t_name").value.trim();
      const specStr = $("#t_spec").value;
      const valid = jsonValidate(specStr);
      if(!name){ $("#e_t_name").textContent = "Name is required"; return; }
      $("#e_t_name").textContent = "";

      const payload = { name, spec: valid.ok ? (specStr || null) : null };
      try{
        if(state.selectedTpl && state.selectedTpl.id){
          await updateTemplate(state.selectedTpl.id, payload);
          showToast("Template updated"); $("#kpi_lastop").textContent = "Update";
        }else{
          await createTemplate(payload);
          showToast("Template created"); $("#kpi_lastop").textContent = "Create";
        }
        closeTplModal();
        fetchTemplates().catch(err=>showToast(err.message));
      }catch(err){ showToast(err.message); }
    });

    /* ================= ATTACH MODAL ================= */
    const dlgAttach = $("#dlgAttach");
    $("#dlgAttachClose").addEventListener("click", closeAttachModal);
    $("#abtnCancel").addEventListener("click", closeAttachModal);
    $("#abtnSearch").addEventListener("click", (e)=>{ e.preventDefault(); fetchSensorsForAttach().catch(err=>showToast(err.message)); });
    $("#abtnReset").addEventListener("click", (e)=>{ e.preventDefault(); $("#af_name").value=""; $("#af_type").value=""; $("#af_device").value=""; fetchSensorsForAttach().catch(err=>showToast(err.message)); });
    $("#chkAll").addEventListener("change", (e)=>{
      document.querySelectorAll('.attachRowChk').forEach(c=> c.checked = e.target.checked );
      updateAttachCount();
    });

    async function openAttachModal(templateRow){
      state.selectedTpl = templateRow;
      $("#dlgAttachTitle").textContent = `Attach Sensors → ${templateRow?.name || ""}`;
      dlgAttach.classList.remove("hidden"); dlgAttach.classList.add("grid");
      await fetchDevicesOptions();
      await fetchSensorsForAttach();
    }
    function closeAttachModal(){ dlgAttach.classList.add("hidden"); dlgAttach.classList.remove("grid"); state.selectedTpl = null; }

    function renderAttachTable(){
      const tb = $("#attachTBody"); tb.innerHTML = "";
      const rows = state.attachSensorRows || [];
      $("#attachEmpty").classList.toggle("hidden", rows.length>0);
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2"><input class="attachRowChk" type="checkbox" data-id="${r.id}"></td>
          <td class="px-4 py-2">${escapeHtml(r.name || "")}</td>
          <td class="px-4 py-2">${escapeHtml(r.type || "")}</td>
          <td class="px-4 py-2">${escapeHtml(r.device?.name || r.device_id || "—")}</td>
          <td class="px-4 py-2">${escapeHtml(r.unit || "")}</td>
          <td class="px-4 py-2">${escapeHtml(r.address || "")}</td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('.attachRowChk').forEach(c=> c.addEventListener("change", updateAttachCount));
      updateAttachCount();
    }

    function updateAttachCount(){
      const n = [...document.querySelectorAll('.attachRowChk')].filter(c=>c.checked).length;
      $("#attachSelCount").textContent = `${n} selected`;
    }

    $("#abtnAttach").addEventListener("click", async ()=>{
      const ids = [...document.querySelectorAll('.attachRowChk')].filter(c=>c.checked).map(c=> c.getAttribute("data-id"));
      if(!ids.length){ showToast("Select at least one sensor"); return; }
      if(!state.selectedTpl?.id){ showToast("No template selected"); return; }
      try{
        await attachTemplateToSensors(state.selectedTpl.id, ids);
        showToast("Template attached");
        $("#kpi_lastop").textContent = "Attach";
        closeAttachModal();
        fetchTemplates().catch(err=>showToast(err.message));
      }catch(e){ showToast(e.message); }
    });
// ss

// View Attached modal state
const vstate = { page:1, per_page:10, total:0, template: null };

async function openAttachedListModal(templateRow){
  vstate.template = templateRow;
  $("#dlgAttachedListTitle").textContent = `Attached Sensors — ${templateRow?.name || ""}`;
  await populateViewFilters();
  await fetchAttachedList();
  $("#dlgAttachedList").classList.remove("hidden");
  $("#dlgAttachedList").classList.add("grid");
}
function closeAttachedListModal(){
  $("#dlgAttachedList").classList.add("hidden");
  $("#dlgAttachedList").classList.remove("grid");
  vstate.template = null;
}

$("#dlgAttachedListClose").addEventListener("click", closeAttachedListModal);

async function populateViewFilters(){
  // reuse devices endpoint
  try{
    const url = API_BASE + EP_DEVICE_LIST + "?" + qs({ page:1, per_page:1000 });
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) return;
    const data = await res.json();
    const sel = $("#vf_device");
    sel.innerHTML = '<option value="">All devices</option>' + (data.items||[]).map(d=>`<option value="${escapeHtml(d.id)}">${escapeHtml(d.name || d.id)}</option>`).join("");
  }catch(e){}
}

async function fetchAttachedList(){
  if(!vstate.template?.id) return;
  const params = {
    templateId: vstate.template.id,
    page: vstate.page,
    per_page: vstate.per_page,
    name: $("#vf_name").value.trim() || undefined,
    type: $("#vf_type").value.trim() || undefined,
    device_id: $("#vf_device").value.trim() || undefined
  };
  const url = API_BASE + EP_TEMPLATE_ATTACHED + "?" + qs(params);
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok){ showToast("Failed to load attached sensors"); return; }
  const data = await res.json();
  vstate.total = data.total ?? (data.items||[]).length;
  renderAttachedList(data.items || []);
  renderAttachedPager();
}

function renderAttachedList(items){
  const tb = $("#attachedListBody"); tb.innerHTML = "";
  $("#attachedListEmpty").classList.toggle("hidden", (items.length>0));
  items.forEach(r=>{
    const minmax = [r.min_value, r.max_value].map(v => (v ?? "") === "" ? "—" : v).join(" / ");
    const cfg = r.has_config ? '<span class="inline-flex items-center rounded-full border border-blue-200 bg-blue-50 text-blue-700 px-2 py-0.5 text-[11px]">Yes</span>' : '—';
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-4 py-2">${escapeHtml(r.name || "")}</td>
      <td class="px-4 py-2">${escapeHtml(String(r.type || ""))}</td>
      <td class="px-4 py-2">${escapeHtml(r.device_name || r.device_id || "—")}</td>
      <td class="px-4 py-2">${escapeHtml(r.unit || "")}</td>
      <td class="px-4 py-2">${escapeHtml(r.address || "")}</td>
      <td class="px-4 py-2">${escapeHtml(minmax)}</td>
      <td class="px-4 py-2">${cfg}</td>
    `;
    tb.appendChild(tr);
  });
}

function renderAttachedPager(){
  const totalPages = Math.max(1, Math.ceil(vstate.total / vstate.per_page));
  $("#attachedListInfo").textContent = `Page ${vstate.page} / ${totalPages} — ${vstate.total} items`;
  $("#vpgInput").value = vstate.page;
  $("#vpgPrev").disabled = vstate.page <= 1;
  $("#vpgNext").disabled = vstate.page >= totalPages;
}

// Filters + pager events
$("#vbtnSearch").addEventListener("click", ()=>{ vstate.page = 1; fetchAttachedList(); });
$("#vbtnReset").addEventListener("click", ()=>{ $("#vf_name").value=""; $("#vf_type").value=""; $("#vf_device").value=""; vstate.page=1; fetchAttachedList(); });

$("#vpgPrev").addEventListener("click", ()=>{ if(vstate.page>1){ vstate.page--; fetchAttachedList(); }});
$("#vpgNext").addEventListener("click", ()=>{
  const totalPages = Math.max(1, Math.ceil(vstate.total / vstate.per_page));
  if(vstate.page<totalPages){ vstate.page++; fetchAttachedList(); }
});
$("#vpgInput").addEventListener("change", (e)=>{
  const v = Math.max(1, parseInt(e.target.value || "1",10));
  const totalPages = Math.max(1, Math.ceil(vstate.total / vstate.per_page));
  vstate.page = Math.min(v,totalPages);
  fetchAttachedList();
});
$("#vpgSize").addEventListener("change", (e)=>{
  vstate.per_page = parseInt(e.target.value,10);
  vstate.page = 1;
  fetchAttachedList();
});

    /* ================= INIT ================= */
    (async function init(){
      try{ await fetchTemplates(); }catch(e){ showToast(e.message); }
    })();
  </script>
</body>
</html>
